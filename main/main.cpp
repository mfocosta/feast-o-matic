#define BLYNK_TEMPLATE_ID "TMPL5EYqEi5QT"
#define BLYNK_TEMPLATE_NAME "FeastOMatic"
#define BLYNK_AUTH_TOKEN "XhE4zGnJPuIG1JD-6dRZ1afRlEBsy8d8"


#include <stdio.h>
#include "Arduino.h"
#include "HX711.h"
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Stepper.h>
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>
#include "DHT.h"





// Configurações do DHT
#define DHTPIN 4      // Pino digital onde o DHT11 está ligado
#define DHTTYPE DHT11 // Tipo de sensor DHT

// Inicializa o sensor DHT
DHT dht(DHTPIN, DHTTYPE);

// Definir os pinos da célula de carga e motor de passo
#define LOADCELL_DOUT_PIN 25
#define LOADCELL_SCK_PIN 26

// Definir os pinos do ULN2003 conectados ao ESP32
#define IN1 14
#define IN2 12
#define IN3 13
#define IN4 33

// Configuração do motor de passo
const int stepsPerRevolution = 2048;  // Passos por rotação do 28BYJ-48
Stepper stepper(stepsPerRevolution, IN1, IN3, IN2, IN4);  // Definindo a ordem dos pinos

// Configuração do display OLED
#define SCREEN_WIDTH 128  // Largura do display OLED
#define SCREEN_HEIGHT 64  // Altura do display OLED
#define OLED_RESET    -1  // Pino de reset (não utilizado neste display)
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

HX711 scale;

// Variáveis para armazenar a temperatura e umidade
float temperatura;
float humidade;
const int ledPin = 5;



float calibration_factor = -1057;  // Fator de calibração ajustado
float target_weight = 15.0;        // Peso desejado em gramas (definido pelo app Blynk)
float current_weight = 0;          // Peso atual lido
float previous_weight = 0;         // Armazena o peso anterior para evitar ações repetitivas
bool manual_motor_control = false; // Flag para controle manual do motor

// Credenciais WiFi e Blynk Auth Token
char ssid[] = "Leitao_oneplus";        // Substitua com o nome da sua rede WiFi
char pass[] = "123456789";       // Substitua com a senha da sua rede WiFi

// Função para desativar as bobinas do motor de passo
void desativarMotor() {
digitalWrite(IN1, LOW);
digitalWrite(IN2, LOW);
digitalWrite(IN3, LOW);
digitalWrite(IN4, LOW);
}

// Função para ativar ou desativar o controle manual do motor
BLYNK_WRITE(V2) {
manual_motor_control = param.asInt();  // Lê o valor do botão no Blynk (V2)
if (manual_motor_control) {
    Serial.println("Controle manual ativado. Girando motor.");
    stepper.step(1024);  // Gira o motor em pequenos passos
} else {
    Serial.println("Controle manual desativado. Motor parado.");
    desativarMotor();   // Desativa o motor
}
}

BLYNK_WRITE(V1) {
target_weight = param.asFloat();  // Lê o valor do Slider/Input Box no Blynk e define o novo peso alvo
}

// Variável para armazenar o estado do botão Blynk
int displayOption = 0;

BLYNK_WRITE(V5) {
displayOption = param.asInt(); // 0 ou 1
}

// Bitmap do logotipo (substitua isso com o seu próprio bitmap)
const unsigned char myLogo [] = {

    
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x10, 0x04, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x18, 0x0c, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x18, 0x04, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x10, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x01, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x40, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x40, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0x20, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0x03, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xf1, 0xc7, 0xff, 0xf8, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0x03, 0xff, 0xff, 0xfe, 0x7f, 0xf0, 0x3f, 0xf1, 0xc7, 0xff, 0x3f, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0x3f, 0xff, 0xff, 0xfe, 0x7f, 0xe3, 0x1f, 0xf1, 0xc7, 0xff, 0x3f, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0x3f, 0x8f, 0x07, 0x84, 0x1f, 0xe7, 0x9f, 0xf0, 0xc7, 0x06, 0x0c, 0xe1, 0xff, 0xff, 
    0xff, 0xff, 0x3f, 0x27, 0x07, 0x04, 0x1f, 0xe7, 0x8f, 0xf0, 0x87, 0x06, 0x08, 0xc0, 0xff, 0xff, 
    0xff, 0xff, 0x3e, 0x73, 0xf2, 0x7e, 0x7f, 0xe7, 0x8f, 0xf0, 0x87, 0xe3, 0x38, 0xcf, 0xff, 0xff, 
    0xff, 0xff, 0x06, 0x73, 0xf2, 0x3e, 0x78, 0x67, 0x88, 0x32, 0x87, 0xf3, 0x38, 0x8f, 0xff, 0xff, 
    0xff, 0xff, 0x06, 0x03, 0x03, 0x0e, 0x70, 0x67, 0x88, 0x32, 0xa3, 0x03, 0x38, 0x8f, 0xff, 0xff, 
    0xff, 0xff, 0x3e, 0x02, 0x23, 0x86, 0x7f, 0xe7, 0x8f, 0xf2, 0x32, 0x23, 0x38, 0x8f, 0xff, 0xff, 
    0xff, 0xff, 0x3e, 0x7e, 0x73, 0xe2, 0x7f, 0xe7, 0x9f, 0xe2, 0x32, 0x73, 0x38, 0x8f, 0xff, 0xff, 
    0xff, 0xff, 0x3e, 0x7e, 0x63, 0xe2, 0x7f, 0xe3, 0x9f, 0xe2, 0x32, 0x63, 0x38, 0xcf, 0xff, 0xff, 
    0xff, 0xff, 0x3f, 0x02, 0x02, 0x06, 0x1f, 0xf0, 0x3f, 0xe7, 0xf2, 0x03, 0x0c, 0xc0, 0xff, 0xff, 
    0xff, 0xff, 0x3f, 0x87, 0x1b, 0x0f, 0x0f, 0xf8, 0x7f, 0xe7, 0xf3, 0x1b, 0x8c, 0xe1, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};


void showLogo() {
display.clearDisplay(); 
display.drawBitmap(0, 0, myLogo, 128, 64, WHITE);  // Desenha o logotipo no display
display.display();  // Atualiza o display
delay(3000);  // Mantém o logotipo visível por 3 segundos
}




extern "C" void app_main()
{
    initArduino();


    Serial.begin(115200);  // Inicia a comunicação serial
    dht.begin();
    pinMode(ledPin, OUTPUT);
    
    // Inicializar o display OLED
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {  // Endereço I2C 0x3C para o display OLED
        Serial.println(F("Falha ao inicializar o display OLED"));
        for(;;);
    }

    // Exibe o logotipo durante o carregamento
    showLogo();
    
    // Inicializa Blynk
    Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);

    display.clearDisplay();
    display.setTextSize(1.5);
    display.setTextColor(WHITE);
    display.setCursor(0, 0);
    display.println("Sistema Iniciado");
    display.display();

    // Iniciar a célula de carga
    scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
    scale.set_scale(calibration_factor);
    scale.tare();  // Zera a balança com a tigela vazia

    // Configurar a velocidade do motor de passo
    stepper.setSpeed(10);  // Velocidade em rotações por minuto (RPM)
    
    Serial.println("Sistema pronto. Coloque a tigela vazia.");
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("Pronto. Coloque a tigela.");
    display.display();


    for(;;) {  // Loop principal
        Blynk.run();  // Executa o Blynk

        // Ler o peso atual da célula de carga
        current_weight = scale.get_units();  
        
        // Envia o peso lido para o Blynk (para o Display LCD no app)
        Blynk.virtualWrite(V0, current_weight);  // Atualiza o valor do Display LCD (V0) no app Blynk
        
        // Exibir o peso atual no monitor serial e no display OLED
        Serial.print("Peso lido: ");
        Serial.print(current_weight, 2);
        Serial.println(" g");

        // Atualiza os dados no Blynk
        Blynk.virtualWrite(V4, humidade);     // Envia umidade para V4
        Blynk.virtualWrite(V3, temperatura);  // Envia temperatura para V3

        if (displayOption == 0) {
            humidade = dht.readHumidity(); // Lê a umidade
            temperatura = dht.readTemperature(); // Lê a temperatura em Celsius
            
            // Mostra os dados no OLED
        if (isnan(temperatura) || isnan(humidade)) {
            display.println("Erro ao ler DHT11");
            } else {
            display.clearDisplay();
            display.setCursor(0, 0);
            display.println("Sensor DHT11:");
            display.print("Temperatura: ");
            display.print(temperatura);
            display.println(" C");
            display.print("Humidade: ");
            display.print(humidade);
            display.println(" %");
            }
        } else {

        display.clearDisplay();
        display.setCursor(0, 0);
        display.println("Peso atual:");
        display.setCursor(0, 20);
        display.print(current_weight, 2);
        display.println(" g");

        }

        // Controle automático baseado no peso
        if (!manual_motor_control) {  // Verifica se o controle manual está desativado
            if (current_weight < target_weight) {
            if (previous_weight != current_weight) {  // Executa apenas se o peso mudou
                for(int dutyCycle = 0; dutyCycle <= 255; dutyCycle++){   
                // changing the LED brightness with PWM
                analogWrite(ledPin, dutyCycle);
                
                }

                // decrease the LED brightness
                for(int dutyCycle = 255; dutyCycle >= 0; dutyCycle--){
                // changing the LED brightness with PWM
                analogWrite(ledPin, dutyCycle);
                
                }

                stepper.step(-2048);  // Gira o motor para dispensar comida
                stepper.step(256);    // Ajusta o motor de volta
                previous_weight = current_weight;  // Atualiza o peso anterior
                //display.setCursor(0, 40);
                //display.println("Dispensando comida...");
                //display.display();  // Atualiza o conteúdo do display OLED
            }
            } else {
            display.setCursor(0, 40);
            //display.println("Peso alvo atingido.");
            Serial.println("Peso alvo atingido! Motor parado.");
            desativarMotor();   // Desativa o motor após atingir o peso alvo
            }
        }

        display.display();  // Atualiza o conteúdo do display OLED
        vTaskDelay(500 / portTICK_PERIOD_MS);  // Aguardar meio segundo antes da próxima leitura
    }


    // WARNING: if program reaches end of function app_main() the MCU will restart ????????
}